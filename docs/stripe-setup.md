# Stripe Subscription Plans Setup Guide

This guide walks you through setting up subscription plans in Stripe for your SaaS application.

## Overview

The application supports three subscription tiers:

| Plan | Price | Features |
|------|--------|----------|
| **Starter** | $9.99/month | 3 projects, Basic analytics, Email support, 5GB storage |
| **Pro** | $29.99/month | 10 projects, Advanced analytics, Priority support, 50GB storage, Team collaboration |
| **Enterprise** | $99.99/month | Unlimited projects, Custom analytics, 24/7 phone support, 500GB storage, Advanced team features, Custom integrations |

## Prerequisites

1. **Stripe Account**: Create a Stripe account at [stripe.com](https://stripe.com)
2. **API Keys**: Get your Stripe API keys from the [Stripe Dashboard](https://dashboard.stripe.com/apikeys)
3. **Environment Setup**: Create a `.env.local` file with your Stripe keys

## Method 1: Automated Setup (Recommended)

### Step 1: Configure Environment Variables

Create or update your `.env.local` file with your Stripe secret key:

```bash
# Stripe Configuration
STRIPE_SECRET_KEY=sk_test_your_secret_key_here
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_your_publishable_key_here
```

### Step 2: Run the Setup Script

The automated script will create all products and prices in your Stripe account:

```bash
# Install dependencies if not already done
npm install

# Run the Stripe setup script
node scripts/setup-stripe.js
```

### Step 3: Update Environment Variables

The script will output the required environment variables. Copy them to your `.env.local`:

```bash
# Stripe Subscription Plan Price IDs (generated by setup script)
STRIPE_STARTER_PRICE_ID=price_1234567890abcdef
STRIPE_PRO_PRICE_ID=price_0987654321fedcba
STRIPE_ENTERPRISE_PRICE_ID=price_abcdef1234567890
```

## Method 2: Manual Setup

If you prefer to set up plans manually in the Stripe Dashboard:

### Step 1: Create Products

1. Go to [Stripe Dashboard > Products](https://dashboard.stripe.com/products)
2. Click **"Add product"**
3. Create each plan with these details:

#### Starter Plan
- **Name**: Starter
- **Description**: Perfect for getting started
- **Price**: $9.99 USD/month (recurring)
- **Metadata**:
  ```
  plan_type: starter
  project_limit: 3
  storage_gb: 5
  support_type: email
  ```

#### Pro Plan
- **Name**: Pro
- **Description**: For growing businesses
- **Price**: $29.99 USD/month (recurring)
- **Metadata**:
  ```
  plan_type: pro
  project_limit: 10
  storage_gb: 50
  support_type: priority
  team_collaboration: true
  ```

#### Enterprise Plan
- **Name**: Enterprise
- **Description**: For large organizations
- **Price**: $99.99 USD/month (recurring)
- **Metadata**:
  ```
  plan_type: enterprise
  project_limit: unlimited
  storage_gb: 500
  support_type: phone_24_7
  team_collaboration: true
  custom_integrations: true
  ```

### Step 2: Copy Price IDs

After creating each product, copy the **Price ID** (starts with `price_`) to your `.env.local`:

```bash
STRIPE_STARTER_PRICE_ID=price_your_starter_price_id
STRIPE_PRO_PRICE_ID=price_your_pro_price_id
STRIPE_ENTERPRISE_PRICE_ID=price_your_enterprise_price_id
```

## Verification

### Test Your Setup

1. **Check Environment Variables**:
   ```bash
   # Verify all required variables are set
   grep STRIPE_ .env.local
   ```

2. **Run the Application**:
   ```bash
   npm run dev
   ```

3. **Test Plan Loading**:
   - Visit your app's pricing page
   - Verify all three plans display correctly
   - Check that prices match your Stripe configuration

### Stripe Dashboard Verification

1. Go to [Stripe Dashboard > Products](https://dashboard.stripe.com/products)
2. Verify you see three products: Starter, Pro, Enterprise
3. Check that each has the correct monthly recurring price
4. Verify metadata is properly set

## Webhook Configuration

For subscription events to work properly, you'll need to set up webhooks:

### Development Webhooks

1. Install Stripe CLI: [https://stripe.com/docs/stripe-cli](https://stripe.com/docs/stripe-cli)
2. Login to Stripe CLI: `stripe login`
3. Forward events to your local app:
   ```bash
   stripe listen --forward-to localhost:3000/api/webhooks/stripe
   ```
4. Copy the webhook signing secret to `.env.local`:
   ```bash
   STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret_here
   ```

### Production Webhooks

1. Go to [Stripe Dashboard > Webhooks](https://dashboard.stripe.com/webhooks)
2. Click **"Add endpoint"**
3. Set endpoint URL: `https://yourdomain.com/api/webhooks/stripe`
4. Select these events:
   - `customer.subscription.created`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
   - `payment_method.attached`
   - `invoice.payment_succeeded`
   - `invoice.payment_failed`
5. Copy the webhook signing secret to your production environment variables

## Troubleshooting

### Common Issues

1. **"No such price" Error**:
   - Verify price IDs in your `.env.local` match those in Stripe Dashboard
   - Ensure you're using the correct Stripe environment (test vs live)

2. **"Invalid API Key" Error**:
   - Check that `STRIPE_SECRET_KEY` is correctly set
   - Verify the key starts with `sk_test_` for test mode or `sk_live_` for live mode

3. **Products Not Appearing**:
   - Run the setup script again: `node scripts/setup-stripe.js`
   - Check for existing products in Stripe Dashboard

### Getting Help

- **Stripe Documentation**: [https://stripe.com/docs](https://stripe.com/docs)
- **Stripe Support**: [https://support.stripe.com](https://support.stripe.com)
- **Application Logs**: Check your Next.js console for detailed error messages

## Security Best Practices

1. **Never commit** `.env.local` or any file containing real API keys
2. **Use test keys** for development and live keys only for production
3. **Regularly rotate** your API keys
4. **Monitor** your Stripe Dashboard for unusual activity
5. **Validate webhooks** using the signature verification

## Next Steps

After setting up subscription plans:

1. **Test Checkout Flow**: Try subscribing to each plan
2. **Verify Webhooks**: Test subscription lifecycle events
3. **Customer Portal**: Set up Stripe Customer Portal for plan management
4. **Billing Logic**: Implement usage limits based on plan features

## Plan Features Configuration

The application checks plan limits based on the metadata set in Stripe. Here's how features are enforced:

```typescript
// Example usage in your application
const userPlan = getUserSubscriptionPlan(userId);

// Check project limit
if (userPlan.metadata.project_limit !== 'unlimited') {
  const limit = parseInt(userPlan.metadata.project_limit);
  if (userProjects.length >= limit) {
    throw new Error('Project limit reached. Upgrade your plan.');
  }
}

// Check storage limit
const storageUsed = getUserStorageUsage(userId);
const storageLimit = parseInt(userPlan.metadata.storage_gb) * 1024 * 1024 * 1024; // Convert GB to bytes
if (storageUsed >= storageLimit) {
  throw new Error('Storage limit reached. Upgrade your plan.');
}
```

This setup provides a flexible foundation for your subscription-based SaaS application! 